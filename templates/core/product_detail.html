{% extends 'base.html' %}
{% load dict_filters %}
{% load permission_tags %}

{% block title %}{{ product.name }} - Produktdetails{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'product_list' %}">Produkte</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="mb-2">{{ product.name }}</h1>
        <p class="text-muted">
            {% if product.category %}
            <span class="badge bg-secondary">{{ product.category.name }}</span>
            {% endif %}
            <span class="badge bg-primary">SKU: {{ product.sku }}</span>
            {% if product.barcode %}
            <span class="badge bg-info">EAN: {{ product.barcode }}</span>
            {% endif %}
        </p>
    </div>
    <div class="col-md-4 text-end">
        {% if perms.product.edit %}
        <a href="{% url 'product_update' product.id %}" class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Bearbeiten
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Linke Spalte mit Foto und Details -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Produktinformationen</h5>
                {% if primary_photo %}
                <a href="{% url 'product_photos' product.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-images"></i> Alle Fotos
                </a>
                {% endif %}
            </div>

            {% if primary_photo %}
            <img src="{{ primary_photo.image.url }}" class="card-img-top" alt="{{ product.name }}">
            {% else %}
            <div class="text-center p-4 bg-light">
                <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                <p class="mt-2 text-muted">Kein Produktfoto vorhanden</p>
                {% if perms.product.edit %}
                <a href="{% url 'product_photo_add' product.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-circle"></i> Foto hinzufügen
                </a>
                {% endif %}
            </div>
            {% endif %}

            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5">SKU:</dt>
                    <dd class="col-sm-7">{{ product.sku }}</dd>

                    <dt class="col-sm-5">Barcode:</dt>
                    <dd class="col-sm-7">{{ product.barcode|default:"Nicht angegeben" }}</dd>

                    <dt class="col-sm-5">Kategorie:</dt>
                    <dd class="col-sm-7">{{ product.category.name|default:"Keine Kategorie" }}</dd>

                    <dt class="col-sm-5">Aktueller Bestand:</dt>
                    <dd class="col-sm-7">
                        <span class="badge {% if product.current_stock <= product.minimum_stock %}bg-danger{% else %}bg-success{% endif %}">
                            {{ total_accessible_stock }} {{ product.unit }}
                        </span>
                    </dd>

                    <dt class="col-sm-5">Mindestbestand:</dt>
                    <dd class="col-sm-7">{{ product.minimum_stock }} {{ product.unit }}</dd>

                    <dt class="col-sm-5">Einheit:</dt>
                    <dd class="col-sm-7">{{ product.unit }}</dd>

                    <dt class="col-sm-5">Varianten:</dt>
                    <dd class="col-sm-7">
                        {% if product.has_variants %}
                        <span class="badge bg-success">Ja ({{ variant_count }})</span>
                        {% else %}
                        <span class="badge bg-secondary">Nein</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5">Seriennummern:</dt>
                    <dd class="col-sm-7">
                        {% if product.has_serial_numbers %}
                        <span class="badge bg-success">Ja ({{ serial_count }})</span>
                        {% else %}
                        <span class="badge bg-secondary">Nein</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5">Chargenverfolgung:</dt>
                    <dd class="col-sm-7">
                        {% if product.has_batch_tracking %}
                        <span class="badge bg-success">Ja ({{ batch_count }})</span>
                        {% else %}
                        <span class="badge bg-secondary">Nein</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col text-muted small">
                        Erstellt am: {{ product.created_at|date:"d.m.Y H:i" }}
                    </div>
                    <div class="col text-end text-muted small">
                        Aktualisiert: {{ product.updated_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rechte Spalte mit Tabs -->
    <div class="col-md-8">
        <ul class="nav nav-tabs mb-3" id="productTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Details</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="suppliers-tab" data-bs-toggle="tab" data-bs-target="#suppliers" type="button" role="tab" aria-controls="suppliers" aria-selected="false">Lieferanten</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="movements-tab" data-bs-toggle="tab" data-bs-target="#movements" type="button" role="tab" aria-controls="movements" aria-selected="false">Bewegungen</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="extras-tab" data-bs-toggle="tab" data-bs-target="#extras" type="button" role="tab" aria-controls="extras" aria-selected="false">Erweitert</button>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="warehouses-tab" data-bs-toggle="tab" href="#warehouses" role="tab" aria-controls="warehouses" aria-selected="false">
                    <i class="fas fa-warehouse me-2"></i>Lagerbestände
                </a>
            </li>
        </ul>
        <div class="tab-content" id="productTabContent">
            <!-- Tab: Details -->
            <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Produktbeschreibung</h5>
                    </div>
                    <div class="card-body">
                        {% if product.description %}
                        <p>{{ product.description|linebreaks }}</p>
                        {% else %}
                        <p class="text-muted">Keine Beschreibung vorhanden.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Anhänge -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Produktanhänge</h5>
                        <a href="{% url 'product_attachments' product.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-files"></i> Alle Anhänge
                        </a>
                    </div>
                    <div class="card-body">
                        {% if product.attachments.exists %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Titel</th>
                                        <th>Typ</th>
                                        <th>Hinzugefügt</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in product.attachments.all|slice:":5" %}
                                    <tr>
                                        <td>{{ attachment.title }}</td>
                                        <td>{{ attachment.file_type|upper }}</td>
                                        <td>{{ attachment.upload_date|date:"d.m.Y" }}</td>
                                        <td>
                                            <a href="{% url 'product_attachment_download' product.id attachment.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine Anhänge vorhanden.</p>
                        {% if perms.product.edit %}
                        <a href="{% url 'product_attachment_add' product.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Anhang hinzufügen
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tab: Lieferanten -->
            <div class="tab-pane fade" id="suppliers" role="tabpanel" aria-labelledby="suppliers-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lieferanteninformationen</h5>
                        {% if perms.supplier.edit %}
                        <a href="{% url 'supplier_product_add' %}?product={{ product.id }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Lieferant hinzufügen
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if supplier_products %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Lieferant</th>
                                        <th>Artikelnr. Lieferant</th>
                                        <th>Einkaufspreis</th>
                                        <th>Lieferzeit</th>
                                        <th>Status</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sp in supplier_products %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'supplier_detail' sp.supplier.id %}">{{ sp.supplier.name }}</a>
                                        </td>
                                        <td>{{ sp.supplier_sku|default:"--" }}</td>
                                        <td>{{ sp.purchase_price }}€</td>
                                        <td>{{ sp.lead_time_days }} Tage</td>
                                        <td>
                                            {% if sp.is_preferred %}
                                            <span class="badge bg-success">Bevorzugt</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if perms.supplier.edit %}
                                            <a href="{% url 'supplier_product_update' sp.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine Lieferanten für dieses Produkt hinterlegt.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tab: Bewegungen -->
            <div class="tab-pane fade" id="movements" role="tabpanel" aria-labelledby="movements-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Letzte Bestandsbewegungen</h5>
                    </div>
                    <div class="card-body">
                        {% if movements %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Art</th>
                                        <th>Menge</th>
                                        <th>Referenz</th>
                                        <th>Benutzer</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for movement in movements %}
                                    <tr>
                                        <td>{{ movement.created_at|date:"d.m.Y H:i" }}</td>
                                        <td>
                                            {% if movement.movement_type == 'in' %}
                                            <span class="badge bg-success">Zugang</span>
                                            {% elif movement.movement_type == 'out' %}
                                            <span class="badge bg-danger">Abgang</span>
                                            {% else %}
                                            <span class="badge bg-warning">Korrektur</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ movement.quantity }} {{ product.unit }}</td>
                                        <td>{{ movement.reference|default:"--" }}</td>
                                        <td>{{ movement.created_by.username }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'stock_movement_list' %}?product={{ product.id }}" class="btn btn-sm btn-outline-secondary">
                                Alle Bewegungen anzeigen
                            </a>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine Bestandsbewegungen vorhanden.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tab: Erweitert -->
            <div class="tab-pane fade" id="extras" role="tabpanel" aria-labelledby="extras-tab">
                <!-- Varianten -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Produktvarianten</h5>
                        <div>
                            {% if product.has_variants %}
                            <a href="{% url 'product_variants' product.id %}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-list"></i> Alle Varianten
                            </a>
                            {% endif %}
                            {% if perms.product.create %}
                            <a href="{% url 'product_variant_add' product.id %}" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-plus-circle"></i> Variante hinzufügen
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if product.has_variants and variant_count > 0 %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>SKU</th>
                                        <th>Typ</th>
                                        <th>Wert</th>
                                        <th>Bestand</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for variant in product.variants.all|slice:":5" %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'product_variant_detail' product.id variant.id %}">
                                                {{ variant.name }}
                                            </a>
                                        </td>
                                        <td>{{ variant.sku }}</td>
                                        <td>{{ variant.variant_type.name }}</td>
                                        <td>{{ variant.value }}</td>
                                        <td>
                                            <span class="badge {% if variant.current_stock == 0 %}bg-danger{% elif variant.current_stock < 3 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ variant.current_stock }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if variant.is_active %}
                                            <span class="badge bg-success">Aktiv</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inaktiv</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if variant_count > 5 %}
                        <div class="text-center mt-2">
                            <a href="{% url 'product_variants' product.id %}" class="btn btn-sm btn-outline-primary">
                                Alle {{ variant_count }} Varianten anzeigen
                            </a>
                        </div>
                        {% endif %}
                        {% else %}
                        <p class="text-muted">Keine Produktvarianten vorhanden.</p>
                        {% if perms.product.create %}
                        <a href="{% url 'product_variant_add' product.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Variante hinzufügen
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Seriennummern -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Seriennummern</h5>
                        <div>
                            {% if product.has_serial_numbers %}
                            <a href="{% url 'product_serials' product.id %}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-list"></i> Alle Seriennummern
                            </a>
                            {% endif %}
                            {% if perms.product.create %}
                            <div class="btn-group">
                                <a href="{% url 'product_serial_add' product.id %}" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-plus-circle"></i> Hinzufügen
                                </a>
                                <a href="{% url 'product_serial_bulk_add' product.id %}" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-plus-circle-fill"></i> Massenimport
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if product.has_serial_numbers and serial_count > 0 %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Seriennummern nach Status</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    {% for status_choice in product.serial_numbers.model.status_choices %}
                                                    <tr>
                                                        <td>{{ status_choice.1 }}</td>
                                                        <td class="text-end">
                                                            <span class="badge bg-primary">
                                                                {{ serial_status_counts|get:status_choice.0|default:"0" }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                {% if expiring_serials %}
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Ablaufende Seriennummern</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    {% for serial in expiring_serials %}
                                                    <tr>
                                                        <td>{{ serial.serial_number }}</td>
                                                        <td>{{ serial.expiry_date|date:"d.m.Y" }}</td>
                                                        <td>
                                                            <span class="badge {% if serial.days_until_expiry < 7 %}bg-danger{% else %}bg-warning{% endif %}">
                                                                {{ serial.days_until_expiry }} Tage
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine Seriennummern vorhanden.</p>
                        {% if perms.product.create %}
                        <div class="btn-group">
                            <a href="{% url 'product_serial_add' product.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-plus-circle"></i> Seriennummer hinzufügen
                            </a>
                            <a href="{% url 'product_serial_bulk_add' product.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-plus-circle-fill"></i> Massenimport
                            </a>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Chargen -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Chargenverfolgung</h5>
                        <div>
                            {% if product.has_batch_tracking %}
                            <a href="{% url 'product_batches' product.id %}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-list"></i> Alle Chargen
                            </a>
                            {% endif %}
                            {% if perms.product.create %}
                            <a href="{% url 'product_batch_add' product.id %}" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-plus-circle"></i> Charge hinzufügen
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if product.has_batch_tracking and batch_count > 0 %}
                        <div class="row">
                            <div class="col-md-12">
                                {% if expiring_batches %}
                                <div class="card mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">Ablaufende Chargen</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Chargennummer</th>
                                                        <th>Menge</th>
                                                        <th>Lager</th>
                                                        <th>Verfallsdatum</th>
                                                        <th>Verbleibend</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for batch in expiring_batches %}
                                                    <tr>
                                                        <td>{{ batch.batch_number }}</td>
                                                        <td>{{ batch.quantity }}</td>
                                                        <td>{{ batch.warehouse.name|default:"--" }}</td>
                                                        <td>{{ batch.expiry_date|date:"d.m.Y" }}</td>
                                                        <td>
                                                            <span class="badge {% if batch.days_until_expiry < 7 %}bg-danger{% else %}bg-warning{% endif %}">
                                                                {{ batch.days_until_expiry }} Tage
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Chargennummer</th>
                                                <th>Menge</th>
                                                <th>Produktionsdatum</th>
                                                <th>Verfallsdatum</th>
                                                <th>Lager</th>
                                                <th>Lieferant</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for batch in product.batches.all|slice:":5" %}
                                            <tr>
                                                <td>{{ batch.batch_number }}</td>
                                                <td>{{ batch.quantity }} {{ product.unit }}</td>
                                                <td>{{ batch.production_date|date:"d.m.Y"|default:"--" }}</td>
                                                <td>
                                                    {% if batch.expiry_date %}
                                                    <span class="{% if batch.is_expired %}text-danger{% elif batch.days_until_expiry < 30 %}text-warning{% endif %}">
                                                        {{ batch.expiry_date|date:"d.m.Y" }}
                                                    </span>
                                                    {% else %}
                                                    --
                                                    {% endif %}
                                                </td>
                                                <td>{{ batch.warehouse.name|default:"--" }}</td>
                                                <td>{{ batch.supplier.name|default:"--" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if batch_count > 5 %}
                                <div class="text-center mt-2">
                                    <a href="{% url 'product_batches' product.id %}" class="btn btn-sm btn-outline-primary">
                                        Alle {{ batch_count }} Chargen anzeigen
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine Chargeninformationen vorhanden.</p>
                        {% if perms.product.create %}
                        <a href="{% url 'product_batch_add' product.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Charge hinzufügen
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="warehouses" role="tabpanel" aria-labelledby="warehouses-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lagerbestände</h5>
                        <div class="btn-group">
                            {% if user|has_perm:'inventory:edit' %}
                                <a href="{% url 'bulk_warehouse_transfer' %}?product={{ product.id }}" class="btn btn-sm btn-primary me-2">
                                    <i class="fas fa-exchange-alt me-1"></i>Bestand umlagern
                                </a>
                            {% endif %}
                            {% if user|has_perm:'inventory:edit' %}
                                <a href="{% url 'stock_adjustment' product.id %}" class="btn btn-sm btn-warning">
                                    <i class="bi bi-pencil-square me-1"></i> Bestand korrigieren
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle fa-2x me-3"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="alert-heading">Gesamtbestand</h5>
                                        <p class="mb-0">
                                            Summe über alle zugänglichen Lager: 
                                            <strong>{{ total_accessible_stock }} {{ product.unit }}</strong>
                                            {% if total_accessible_stock <= product.minimum_stock and total_accessible_stock > 0 %}
                                                <span class="badge bg-warning ms-2">Kritischer Bestand</span>
                                            {% elif total_accessible_stock == 0 %}
                                                <span class="badge bg-danger ms-2">Kein Bestand</span>
                                            {% else %}
                                                <span class="badge bg-success ms-2">Ausreichender Bestand</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Lager</th>
                                        <th>Standort</th>
                                        <th>Bestand</th>
                                        <th>Status</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock in warehouse_stocks %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'warehouse_detail' stock.warehouse.id %}">
                                                {{ stock.warehouse.name }}
                                            </a>
                                        </td>
                                        <td>{{ stock.warehouse.location }}</td>
                                        <td>{{ stock.quantity }} {{ product.unit }}</td>
                                        <td>
                                            {% if stock.quantity <= product.minimum_stock and stock.quantity > 0 %}
                                                <span class="badge bg-warning">Kritisch</span>
                                            {% elif stock.quantity == 0 %}
                                                <span class="badge bg-danger">Nicht verfügbar</span>
                                            {% else %}
                                                <span class="badge bg-success">Verfügbar</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{% url 'warehouse_detail' stock.warehouse.id %}" class="btn btn-sm btn-outline-info">
                                                    <i class="bi bi-boxes"></i>
                                                </a>
                                                {% if user|has_perm:'inventory:edit' %}
                                                <a href="{% url 'bulk_warehouse_transfer' %}?product={{ product.id }}&source={{ stock.warehouse.id }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-arrow-left-right"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            Dieses Produkt ist in keinem Ihrer zugänglichen Lager verfügbar.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}