{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .field-section {
        display: none;
    }
    .required-field label:after {
        content: " *";
        color: red;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ title }}</h1>
        <div>
            {% if interface %}
                <a href="{% url 'interface_detail' pk=interface.id %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Abbrechen
                </a>
            {% else %}
                <a href="{% url 'interface_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Abbrechen
                </a>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Schnittstellenkonfiguration</h5>
        </div>
        <div class="card-body">
            <form method="post" id="interface-form">
                {% csrf_token %}
                
                <!-- Allgemeine Informationen -->
                <div class="mb-4">
                    <h4>Allgemeine Informationen</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 required-field">
                                <label for="id_supplier" class="form-label">Lieferant</label>
                                {{ form.supplier }}
                                {% if form.supplier.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.supplier.errors }}
                                    </div>
                                {% endif %}
                                {% if form.supplier.help_text %}
                                    <div class="form-text">{{ form.supplier.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 required-field">
                                <label for="id_name" class="form-label">Schnittstellenname</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.name.errors }}
                                    </div>
                                {% endif %}
                                {% if form.name.help_text %}
                                    <div class="form-text">{{ form.name.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 required-field">
                                <label for="id_interface_type" class="form-label">Schnittstellentyp</label>
                                {{ form.interface_type }}
                                {% if form.interface_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.interface_type.errors }}
                                    </div>
                                {% endif %}
                                {% if form.interface_type.help_text %}
                                    <div class="form-text">{{ form.interface_type.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_order_format" class="form-label">Bestellformat</label>
                                {{ form.order_format }}
                                {% if form.order_format.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.order_format.errors }}
                                    </div>
                                {% endif %}
                                {% if form.order_format.help_text %}
                                    <div class="form-text">{{ form.order_format.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.is_active }}
                                <label class="form-check-label" for="id_is_active">
                                    Schnittstelle ist aktiv
                                </label>
                                {% if form.is_active.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_active.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.is_default }}
                                <label class="form-check-label" for="id_is_default">
                                    Als Standard-Schnittstelle für diesen Lieferanten verwenden
                                </label>
                                {% if form.is_default.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_default.errors }}
                                    </div>
                                {% endif %}
                                {% if form.is_default.help_text %}
                                    <div class="form-text">{{ form.is_default.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- API/Web-Konfiguration -->
                <div id="api-section" class="field-section mb-4">
                    <h4>API/Web-Konfiguration</h4>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3 api-required">
                                <label for="id_api_url" class="form-label">API-URL</label>
                                {{ form.api_url }}
                                {% if form.api_url.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.api_url.errors }}
                                    </div>
                                {% endif %}
                                {% if form.api_url.help_text %}
                                    <div class="form-text">{{ form.api_url.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_username_dynamic" class="form-label">Benutzername</label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.username.errors }}
                                    </div>
                                {% endif %}
                                {% if form.username.help_text %}
                                    <div class="form-text">{{ form.username.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_password_dynamic" class="form-label">Passwort</label>
                                {{ form.password }}
                                {% if form.password.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password.errors }}
                                    </div>
                                {% endif %}
                                {% if form.password.help_text %}
                                    <div class="form-text">{{ form.password.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_api_key" class="form-label">API-Schlüssel</label>
                                {{ form.api_key }}
                                {% if form.api_key.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.api_key.errors }}
                                    </div>
                                {% endif %}
                                {% if form.api_key.help_text %}
                                    <div class="form-text">{{ form.api_key.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- FTP/SFTP-Konfiguration -->
                <div id="ftp-section" class="field-section mb-4">
                    <h4>FTP/SFTP-Konfiguration</h4>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3 ftp-required">
                                <label for="id_host" class="form-label">Host</label>
                                {{ form.host }}
                                {% if form.host.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.host.errors }}
                                    </div>
                                {% endif %}
                                {% if form.host.help_text %}
                                    <div class="form-text">{{ form.host.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_port" class="form-label">Port</label>
                                {{ form.port }}
                                {% if form.port.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.port.errors }}
                                    </div>
                                {% endif %}
                                {% if form.port.help_text %}
                                    <div class="form-text">{{ form.port.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_remote_path" class="form-label">Remote-Pfad</label>
                                {{ form.remote_path }}
                                {% if form.remote_path.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.remote_path.errors }}
                                    </div>
                                {% endif %}
                                {% if form.remote_path.help_text %}
                                    <div class="form-text">{{ form.remote_path.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 ftp-required">
                                <label for="id_username_dynamic" class="form-label">Benutzername</label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.username.errors }}
                                    </div>
                                {% endif %}
                                {% if form.username.help_text %}
                                    <div class="form-text">{{ form.username.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 ftp-required">
                                <label for="id_password_dynamic" class="form-label">Passwort</label>
                                {{ form.password }}
                                {% if form.password.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password.errors }}
                                    </div>
                                {% endif %}
                                {% if form.password.help_text %}
                                    <div class="form-text">{{ form.password.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- E-Mail-Konfiguration -->
                <div id="email-section" class="field-section mb-4">
                    <h4>E-Mail-Konfiguration</h4>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3 email-required">
                                <label for="id_email_to" class="form-label">Empfänger</label>
                                {{ form.email_to }}
                                {% if form.email_to.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email_to.errors }}
                                    </div>
                                {% endif %}
                                {% if form.email_to.help_text %}
                                    <div class="form-text">{{ form.email_to.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_email_cc" class="form-label">CC</label>
                                {{ form.email_cc }}
                                {% if form.email_cc.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email_cc.errors }}
                                    </div>
                                {% endif %}
                                {% if form.email_cc.help_text %}
                                    <div class="form-text">{{ form.email_cc.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_email_subject_template" class="form-label">Betreffvorlage</label>
                                {{ form.email_subject_template }}
                                {% if form.email_subject_template.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email_subject_template.errors }}
                                    </div>
                                {% endif %}
                                {% if form.email_subject_template.help_text %}
                                    <div class="form-text">{{ form.email_subject_template.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Formatierungsvorlagen -->
                <div id="format-section" class="mb-4">
                    <h4>Formatierungsvorlage</h4>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_template" class="form-label">Vorlage</label>
                                {{ form.template }}
                                {% if form.template.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.template.errors }}
                                    </div>
                                {% endif %}
                                {% if form.template.help_text %}
                                    <div class="form-text">{{ form.template.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Erweiterte Konfiguration -->
                <div id="extended-config-section" class="field-section mb-4">
                    <h4>Erweiterte Konfiguration</h4>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_config_json" class="form-label">Zusätzliche Konfiguration (JSON)</label>
                                {{ form.config_json }}
                                {% if form.config_json.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.config_json.errors }}
                                    </div>
                                {% endif %}
                                {% if form.config_json.help_text %}
                                    <div class="form-text">{{ form.config_json.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
    console.log('Document ready - initializing interface form script');

    // Umfangreichere Debugging-Funktion
    function updateFieldVisibility() {
        console.group('Update Field Visibility');
        
        // Sicherstellen, dass jQuery korrekt funktioniert
        if (!$) {
            console.error('jQuery not loaded correctly');
            return;
        }

        // Debug-Ausgaben für aktuellen Status
        console.log('Interface Type Element:', $('#id_interface_type'));
        console.log('Interface Type Value:', $('#id_interface_type').val());
        
        var $selectedOption = $('#id_interface_type').find('option:selected');
        var interfaceType = $selectedOption.text().toLowerCase();
        
        console.log('Selected Option:', $selectedOption);
        console.log('Selected Interface Type:', interfaceType);

        // Zunächst ALLE Sektionen ausblenden
        [
            '#api-section', 
            '#ftp-section', 
            '#email-section', 
            '#format-section', 
            '#extended-config-section'
        ].forEach(function(selector) {
            console.log(`Hiding section: ${selector}`);
            $(selector).hide();
        });

        // Pflichtfeld-Klassen entfernen
        [
            '.api-required', 
            '.ftp-required', 
            '.email-required'
        ].forEach(function(selector) {
            $(selector).removeClass('required-field');
        });

        // Wenn kein Typ ausgewählt, abbrechen
        if (!$('#id_interface_type').val()) {
            console.log('No interface type selected');
            console.groupEnd();
            return;
        }

        // Sektionen basierend auf Schnittstellentyp einblenden
        if (interfaceType.includes('api') || interfaceType.includes('web')) {
            console.log('Showing API sections');
            $('#api-section, #extended-config-section').show();
            $('.api-required').addClass('required-field');
        } else if (interfaceType.includes('ftp') || interfaceType.includes('sftp')) {
            console.log('Showing FTP sections');
            $('#ftp-section, #extended-config-section').show();
            $('.ftp-required').addClass('required-field');
        } else if (interfaceType.includes('email')) {
            console.log('Showing Email section');
            $('#email-section').show();
            $('.email-required').addClass('required-field');
        }

        // Format-Sektion für XML und Custom
        var format = $('#id_order_format').val();
        if (format === 'xml' || format === 'custom') {
            console.log('Showing Format section');
            $('#format-section').show();
        }

        console.groupEnd();
    }

    // Ereignisse binden mit zusätzlichem Logging
    $('#id_interface_type').on('change', function() {
        console.log('Interface Type changed');
        updateFieldVisibility();
        
        var typeId = $(this).val();
        
        if (typeId) {
            $.ajax({
                url: '{% url 'get_interface_fields' %}',
                data: { 'interface_type_id': typeId },
                dataType: 'json',
                success: function(data) {
                    console.log('Interface Fields Data:', data);
                    if (data.success) {
                        if (data.type_name.toLowerCase().includes('ftp') && !$('#id_port').val()) {
                            $('#id_port').val(21);
                        } else if (data.type_name.toLowerCase().includes('sftp') && !$('#id_port').val()) {
                            $('#id_port').val(22);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                }
            });
        }
    });

    // Bei Änderung des Formats
    $('#id_order_format').on('change', function() {
        console.log('Order Format changed');
        updateFieldVisibility();
    });

    // Initiale Sichtbarkeit setzen
    updateFieldVisibility();

    // Zusätzliche Initialisierungsdiagnose
    console.log('Interface form script initialized successfully');
});
</script>
{% endblock %}