<!-- templates/order/purchase_order_form.html -->
{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Bestellung bearbeiten{% else %}Neue Bestellung{% endif %} - InventoryPulse{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'purchase_order_list' %}">Bestellungen</a></li>
                    <li class="breadcrumb-item active">
                        {% if form.instance.pk %}Bestellung {{ form.instance.order_number }} bearbeiten{% else %}Neue Bestellung{% endif %}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                {% if form.instance.pk %}Bestellung {{ form.instance.order_number }} bearbeiten{% else %}Neue Bestellung{% endif %}
            </h1>
            <div>
                {% if form.instance.pk %}
                <div class="btn-group">
                    {% if form.instance.status == 'draft' %}
                    <a href="{% url 'purchase_order_submit' form.instance.pk %}" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Zur Genehmigung einreichen
                    </a>
                    {% elif form.instance.status == 'pending' and perms.order.approve %}
                    <a href="{% url 'purchase_order_approve' form.instance.pk %}" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Genehmigen
                    </a>
                    <a href="{% url 'purchase_order_reject' form.instance.pk %}" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> Ablehnen
                    </a>
                    {% elif form.instance.status == 'approved' %}
                    <a href="{% url 'purchase_order_mark_sent' form.instance.pk %}" class="btn btn-primary">
                        <i class="bi bi-send"></i> Als bestellt markieren
                    </a>
                    {% elif form.instance.status in 'sent,partially_received' %}
                    <a href="{% url 'purchase_order_receive' form.instance.pk %}" class="btn btn-primary">
                        <i class="bi bi-box-seam"></i> Wareneingang erfassen
                    </a>
                    {% endif %}

                    <a href="{% url 'purchase_order_print' form.instance.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-printer"></i> Drucken
                    </a>
                    <a href="{% url 'purchase_order_export' form.instance.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Export
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="post" id="purchase-order-form">
        {% csrf_token %}

        <div class="row">
            <!-- Linke Spalte: Bestelldaten -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Bestellinformationen</h5>
                    </div>
                    <div class="card-body">
                        {% if form.instance.pk %}
                        <div class="alert alert-info mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-info-circle fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="alert-heading">Status: {{ form.instance.get_status_display }}</h5>
                                    <p class="mb-0">Bestellnummer: {{ form.instance.order_number }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.supplier.id_for_label }}" class="form-label">{{ form.supplier.label }}</label>
                            {{ form.supplier }}
                            {% if form.supplier.errors %}
                            <div class="invalid-feedback d-block">{{ form.supplier.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.expected_delivery.id_for_label }}" class="form-label">{{ form.expected_delivery.label }}</label>
                            {{ form.expected_delivery }}
                            {% if form.expected_delivery.errors %}
                            <div class="invalid-feedback d-block">{{ form.expected_delivery.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.shipping_address.id_for_label }}" class="form-label">{{ form.shipping_address.label }}</label>
                            {{ form.shipping_address }}
                            {% if form.shipping_address.errors %}
                            <div class="invalid-feedback d-block">{{ form.shipping_address.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rechte Spalte: Artikelliste -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Bestellpositionen</h5>
                        {% if not form.instance.pk or form.instance.status == 'draft' %}
                        <button type="button" class="btn btn-sm btn-success" id="addItemButton">
                            <i class="bi bi-plus-circle"></i> Position hinzufügen
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover" id="itemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Produkt</th>
                                        <th>Lieferant-SKU</th>
                                        <th>Menge</th>
                                        <th>Einheit</th>
                                        <th>Einzelpreis</th>
                                        <th>MwSt</th>  <!-- Neue Spalte für MwSt -->
                                        <th>Gesamt</th>
                                        <th style="width: 80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    {% if form.instance.pk %}
                                    {% for item in form.instance.items.all %}
                                        <tr data-item-id="{{ item.id }}">
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <select name="item_product_{{ item.id }}" class="form-select product-select" required>
                                                    <option value="{{ item.product.id }}" selected>{{ item.product.name }}</option>
                                                </select>
                                                {% else %}
                                                {{ item.product.name }}
                                                <input type="hidden" name="item_product_{{ item.id }}" value="{{ item.product.id }}">
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="text" name="item_supplier_sku_{{ item.id }}" class="form-control supplier-sku"
                                                       value="{{ item.supplier_sku }}">
                                                {% else %}
                                                {{ item.supplier_sku }}
                                                <input type="hidden" name="item_supplier_sku_{{ item.id }}" value="{{ item.supplier_sku }}">
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="number" name="item_quantity_{{ item.id }}" class="form-control item-quantity"
                                                      value="{{ item.quantity_ordered }}" min="0.01" step="0.01" required>
                                                {% else %}
                                                {{ item.quantity_ordered }}
                                                <input type="hidden" name="item_quantity_{{ item.id }}" value="{{ item.quantity_ordered }}">
                                                {% endif %}
                                            </td>
                                            <td>{{ item.product.unit }}</td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="number" name="item_price_{{ item.id }}" class="form-control item-price"
                                                      value="{{ item.unit_price }}" min="0.01" step="0.01" required>
                                                {% else %}
                                                {{ item.unit_price }}
                                                <input type="hidden" name="item_price_{{ item.id }}" value="{{ item.unit_price }}">
                                                {% endif %}
                                            </td>
                                            <td class="item-tax-rate">
                                                {% if item.tax %}
                                                    {{ item.tax.rate }}%
                                                    <input type="hidden" name="item_tax_id_{{ item.id }}" class="item-tax-id" value="{{ item.tax.id }}">
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </td>
                                            <td class="item-total">{{ item.line_total }}</td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Zwischensumme:</strong></td>
                                        <td><span id="subtotal">{{ form.instance.subtotal|default:"0.00" }}</span> €</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end">Steuern:</td>
                                        <td>
                                            {% if form.instance.status == 'draft' or not form.instance.pk %}
                                            <input type="number" name="tax" id="taxInput" class="form-control"
                                                   value="{{ form.instance.tax|default:0 }}" min="0" step="0.01">
                                            {% else %}
                                            {{ form.instance.tax }} €
                                            <input type="hidden" name="tax" value="{{ form.instance.tax }}">
                                            {% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end">Versandkosten:</td>
                                        <td>
                                            {% if form.instance.status == 'draft' or not form.instance.pk %}
                                            <input type="number" name="shipping_cost" id="shippingInput" class="form-control"
                                                   value="{{ form.instance.shipping_cost|default:0 }}" min="0" step="0.01">
                                            {% else %}
                                            {{ form.instance.shipping_cost }} €
                                            <input type="hidden" name="shipping_cost" value="{{ form.instance.shipping_cost }}">
                                            {% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Gesamtsumme:</strong></td>
                                        <td><strong><span id="total">{{ form.instance.total|default:"0.00" }}</span> €</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 d-flex justify-content-between">
                <a href="{% url 'purchase_order_list' %}" class="btn btn-outline-secondary">Abbrechen</a>
                {% if not form.instance.pk or form.instance.status == 'draft' %}
                <button type="submit" class="btn btn-primary">Speichern</button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Template für neue Positionen -->
<template id="newItemTemplate">
    <tr data-item-id="new_{index}">
        <td>
            <select name="item_product_new_{index}" class="form-select product-select" required>
                <option value="">-- Produkt wählen --</option>
                {% for product in products %}
                <option value="{{ product.id }}" data-unit="{{ product.unit }}" data-supplier-sku="{{ product.supplier_sku }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" name="item_supplier_sku_new_{index}" class="form-control supplier-sku">
        </td>
        <td>
            <input type="number" name="item_quantity_new_{index}" class="form-control item-quantity"
                   value="1" min="0.01" step="0.01" required>
        </td>
        <td class="item-unit">--</td>
        <td>
            <input type="number" name="item_price_new_{index}" class="form-control item-price"
                   value="0.00" min="0.01" step="0.01" required>
        </td>
        <td class="item-tax-rate">--</td>  <!-- Neue Spalte für die Steuerrate -->
        <td class="item-total">0.00</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
    // Erweiterte JavaScript für das Bestellformular mit korrekter Steuerbehandlung
    // Erweiterte JavaScript für das Bestellformular mit korrekter Steuerbehandlung
$(document).ready(function() {
    let itemIndex = 0;

    // Produktauswahl initialisieren
    initializeProductSelects();

    // Rechenoperationen initialisieren
    initializeCalculations();

    // Lieferanten-Änderung überwachen
    $('#id_supplier').on('change', function() {
        const supplierId = $(this).val();

        if (supplierId) {
            // Aktualisieren der Produktdaten für alle bereits vorhandenen Zeilen
            $('.product-select').each(function() {
                const selectedProductId = $(this).val();
                if (selectedProductId) {
                    fetchAndUpdateProductData($(this), selectedProductId);
                }
            });

            // Lieferanten-Daten abrufen (Versandkosten und Mindestbestellwert)
            $.getJSON('/supplier/get-supplier-data/', {
                supplier_id: supplierId
            }).done(function(data) {
                if (data.success) {
                    // Versandkosten aktualisieren
                    $('#shippingInput').val(data.shipping_cost);

                    // Wenn ein Mindestbestellwert vorhanden ist und er größer als 0 ist
                    if (data.minimum_order_value > 0) {
                        // Hinweis zum Mindestbestellwert anzeigen
                        if (!$('#minimum-order-warning').length) {
                            $('<div id="minimum-order-warning" class="alert alert-warning mt-3">' +
                              '<i class="bi bi-exclamation-triangle me-2"></i>' +
                              'Mindestbestellwert für diesen Lieferanten: <strong>' + data.minimum_order_value + ' €</strong>' +
                              '</div>').insertAfter('#itemsTable');
                        } else {
                            $('#minimum-order-warning strong').text(data.minimum_order_value + ' €');
                        }
                    } else {
                        // Hinweis entfernen, falls kein Mindestbestellwert
                        $('#minimum-order-warning').remove();
                    }

                    // Summen neu berechnen
                    updateTotals();
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Fehler beim Abrufen der Lieferantendaten:', textStatus, errorThrown);
            });
        }
    });

    // Hinzufügen-Button
    $('#addItemButton').click(function() {
        addNewItem();
    });

    // Entfernen-Button für bestehende und neue Zeilen
    $(document).on('click', '.remove-item', function() {
        $(this).closest('tr').remove();
        updateTotals();
    });

    // Funktion zum Hinzufügen einer neuen Position
    function addNewItem() {
        // Template klonen und anpassen
        let template = document.getElementById('newItemTemplate').innerHTML;
        template = template.replace(/{index}/g, itemIndex++);

        // Zum Tabellenkörper hinzufügen
        $('#itemsTableBody').append(template);

        // Selects neu initialisieren
        initializeProductSelects();

        // Berechnungen initialisieren
        initializeCalculations();

        // Scroll zum neuen Element
        $('html, body').animate({
            scrollTop: $("#itemsTableBody tr:last").offset().top - 200
        }, 500);
    }

    // Verbesserte Produktauswahl-Logik
    function initializeProductSelects() {
        // Select2 für Produktauswahl (falls vorhanden)
        if($.fn.select2) {
            $('.product-select').select2({
                placeholder: 'Produkt wählen',
                width: '100%'
            });
        }

        // Änderungen in der Produktauswahl
        $('.product-select').off('change').on('change', function() {
            const productId = $(this).val();
            if (productId) {
                fetchAndUpdateProductData($(this), productId);
            }
        });
    }

    // Funktion zum Abrufen und Aktualisieren der Produktdaten vom Server
    function fetchAndUpdateProductData($select, productId) {
        const $row = $select.closest('tr');
        const supplierId = $('#id_supplier').val();

        if (!supplierId) {
            console.warn('Kein Lieferant ausgewählt!');
            return;
        }

        // AJAX-Anfrage, um Lieferantendaten zu erhalten
        $.getJSON('/order/get-supplier-product-price/', {
            product_id: productId,
            supplier_id: supplierId
        }).done(function(data) {
            console.log('Produktdaten erhalten:', data);

            if (data.success) {
                // Preis setzen, wenn verfügbar
                if (data.price) {
                    $row.find('.item-price').val(data.price);
                }

                // Lieferanten-SKU setzen, wenn verfügbar
                if (data.supplier_sku) {
                    $row.find('.supplier-sku').val(data.supplier_sku);
                }

                // Einheit aktualisieren
                $row.find('.item-unit').text(data.unit || '--');

                // Steuerinformationen speichern
                if (data.tax_id !== null && data.tax_id !== undefined) {
                    // Verstecktes Feld für tax_id erstellen oder aktualisieren
                    const itemId = $row.data('item-id');

                    // Prüfen, ob das Feld bereits existiert
                    let $taxIdField = $row.find('.item-tax-id');
                    if ($taxIdField.length === 0) {
                        // Feld erstellen, wenn es nicht existiert
                        $taxIdField = $('<input>')
                            .attr('type', 'hidden')
                            .addClass('item-tax-id')
                            .attr('name', 'item_tax_id_' + itemId)
                            .appendTo($row);
                    }

                    // Steuersatz setzen
                    $taxIdField.val(data.tax_id);

                    // Steuersatz anzeigen, falls ein entsprechendes Element existiert
                    const $taxRateDisplay = $row.find('.item-tax-rate');
                    if ($taxRateDisplay.length > 0) {
                        $taxRateDisplay.text(data.tax_rate + '%');
                    }
                }

                // Zeilensumme aktualisieren
                updateRowTotal($row);
            } else {
                console.warn('Keine Lieferantendaten gefunden:', data.message);
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Fehler beim Abrufen der Lieferantendaten:', textStatus, errorThrown);
        });
    }

    // Berechnungslogik
    function initializeCalculations() {
        // Menge oder Preis ändert sich
        $('.item-quantity, .item-price').off('input').on('input', function() {
            updateRowTotal($(this).closest('tr'));
        });

        // Steuern oder Versandkosten ändern sich
        $('#taxInput, #shippingInput').off('input').on('input', function() {
            updateTotals();
        });
    }

    // Zeilensumme berechnen
    function updateRowTotal($row) {
        const quantity = parseFloat($row.find('.item-quantity').val()) || 0;
        const price = parseFloat($row.find('.item-price').val()) || 0;
        const total = (quantity * price).toFixed(2);

        $row.find('.item-total').text(total);

        // Gesamtsummen aktualisieren
        updateTotals();
    }

    // Alle Summen aktualisieren
    function updateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        // Alle Positionen summieren und Steuern berechnen
        $('#itemsTableBody tr').each(function() {
            // Zeilensumme ohne Steuern
            const lineTotal = parseFloat($(this).find('.item-total').text()) || 0;
            subtotal += lineTotal;

            // Steuer für diese Zeile berechnen
            const taxRateText = $(this).find('.item-tax-rate').text();
            if (taxRateText && taxRateText !== '--') {
                // Extrahiere die Steuersatz-Zahl (entferne das %-Zeichen)
                const taxRate = parseFloat(taxRateText.replace('%', '')) || 0;
                // Berechne die Steuer für diese Zeile
                const lineTax = lineTotal * (taxRate / 100);
                taxTotal += lineTax;
            }
        });

        // Abrunden auf 2 Dezimalstellen
        subtotal = Math.round(subtotal * 100) / 100;
        taxTotal = Math.round(taxTotal * 100) / 100;

        // Holen und konvertieren der Versandkosten
        const shipping = parseFloat($('#shippingInput').val()) || 0;

        // Gesamtsumme berechnen
        const total = subtotal + taxTotal + shipping;

        // Summen aktualisieren
        $('#subtotal').text(subtotal.toFixed(2));

        // Steuerfeld aktualisieren (Eingabefeld oder Text)
        $('#taxInput').val(taxTotal.toFixed(2));

        // Gesamtsumme aktualisieren
        $('#total').text(total.toFixed(2));
    }

    // Falls es keine Positionen gibt, eine leere hinzufügen
    if($('#itemsTableBody tr').length === 0) {
        addNewItem();
    }

    // Initial die Summen berechnen
    updateTotals();
});
</script>
{% endblock %}