{% extends 'base.html' %}
{% load core_tags %}

{% block title %}{% if form.instance.pk %}Bestellung bearbeiten{% else %}Neue Bestellung{% endif %} - InventoryPulse{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'purchase_order_list' %}">Bestellungen</a></li>
                    <li class="breadcrumb-item active">
                        {% if form.instance.pk %}Bestellung {{ form.instance.order_number }} bearbeiten{% else %}Neue Bestellung{% endif %}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                {% if form.instance.pk %}Bestellung {{ form.instance.order_number }} bearbeiten{% else %}Neue Bestellung{% endif %}
            </h1>
            <div>
                {% if form.instance.pk %}
                <div class="btn-group">
                    {% if form.instance.status == 'draft' %}
                    <a href="{% url 'purchase_order_submit' form.instance.pk %}" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Zur Genehmigung einreichen
                    </a>
                    {% elif form.instance.status == 'pending' and perms.order.approve %}
                    <a href="{% url 'purchase_order_approve' form.instance.pk %}" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Genehmigen
                    </a>
                    <a href="{% url 'purchase_order_reject' form.instance.pk %}" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> Ablehnen
                    </a>
                    {% elif form.instance.status == 'approved' %}
                    <a href="{% url 'purchase_order_mark_sent' form.instance.pk %}" class="btn btn-primary">
                        <i class="bi bi-send"></i> Als bestellt markieren
                    </a>
                    {% elif form.instance.status in 'sent,partially_received' %}
                    <a href="{% url 'purchase_order_receive' form.instance.pk %}" class="btn btn-primary">
                        <i class="bi bi-box-seam"></i> Wareneingang erfassen
                    </a>
                    {% endif %}

                    <a href="{% url 'purchase_order_print' form.instance.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-printer"></i> Drucken
                    </a>
                    <a href="{% url 'purchase_order_export' form.instance.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Export
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% get_default_currency as default_currency %}

    <form method="post" id="purchase-order-form">
        {% csrf_token %}

        <div class="row">
            <!-- Linke Spalte: Bestelldaten -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Bestellinformationen</h5>
                    </div>
                    <div class="card-body">
                        {% if form.instance.pk %}
                        <div class="alert alert-info mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-info-circle fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="alert-heading">Status: {{ form.instance.get_status_display }}</h5>
                                    <p class="mb-0">Bestellnummer: {{ form.instance.order_number }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.supplier.id_for_label }}" class="form-label">{{ form.supplier.label }} <span class="text-danger">*</span></label>
                            {{ form.supplier }}
                            <div id="supplierLoadingIndicator" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary mt-2" role="status">
                                    <span class="visually-hidden">Lädt...</span>
                                </div>
                                <small class="text-muted ms-2">Lade Lieferantendaten...</small>
                            </div>
                            {% if form.supplier.errors %}
                            <div class="invalid-feedback d-block">{{ form.supplier.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.expected_delivery.id_for_label }}" class="form-label">{{ form.expected_delivery.label }}</label>
                            {{ form.expected_delivery }}
                            {% if form.expected_delivery.errors %}
                            <div class="invalid-feedback d-block">{{ form.expected_delivery.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.shipping_address.id_for_label }}" class="form-label">{{ form.shipping_address.label }}</label>
                            {{ form.shipping_address }}
                            {% if form.shipping_address.errors %}
                            <div class="invalid-feedback d-block">{{ form.shipping_address.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rechte Spalte: Produktauswahl und Artikelliste -->
            <div class="col-md-8 mb-4">
                <!-- Produktauswahl-Section -->
                <div id="productSelectionSection" class="card mb-4" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Verfügbare Produkte des Lieferanten</h5>
                        <div>
                            <span class="btn btn-sm btn-outline-secondary" id="toggleProductsBtn">
                                <i class="bi bi-list-ul"></i> Produkte anzeigen/ausblenden
                            </span>
                        </div>
                    </div>
                    <div class="card-body" id="productListContainer" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            Wählen Sie Produkte aus der Liste aus oder verwenden Sie das Suchfeld, um schnell Produkte zu finden.
                            Sie können auch über das Formular unten Produkte manuell hinzufügen.
                        </div>
                        <div id="productList">
                            <!-- Products will be populated here -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Lädt...</span>
                                </div>
                                <p class="mt-2">Produkte werden geladen...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Artikelliste -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Bestellpositionen</h5>
                        {% if not form.instance.pk or form.instance.status == 'draft' %}
                        <button type="button" class="btn btn-sm btn-outline-success" id="addItemButton">
                            <i class="bi bi-plus-circle"></i> Weitere Position
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover" id="itemsTable">
                                <thead>
                                    <tr>
                                        <th>Produkt <span class="text-danger">*</span></th>
                                        <th>Lieferant-SKU</th>
                                        <th>Menge <span class="text-danger">*</span></th>
                                        <th>Einheit</th>
                                        <th>Einzelpreis <span class="text-danger">*</span></th>
                                        <th>MwSt</th>  <!-- Neue Spalte für MwSt -->
                                        <th>Gesamt</th>
                                        <th style="width: 80px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    {% if form.instance.pk %}
                                    {% for item in form.instance.items.all %}
                                        <tr data-item-id="{{ item.id }}">
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <select name="item_product_{{ item.id }}" class="form-select product-select" required>
                                                    <option value="{{ item.product.id }}" selected>{{ item.product.name }}</option>
                                                </select>
                                                {% else %}
                                                {{ item.product.name }}
                                                <input type="hidden" name="item_product_{{ item.id }}" value="{{ item.product.id }}">
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="text" name="item_supplier_sku_{{ item.id }}" class="form-control supplier-sku"
                                                       value="{{ item.supplier_sku }}">
                                                {% else %}
                                                {{ item.supplier_sku }}
                                                <input type="hidden" name="item_supplier_sku_{{ item.id }}" value="{{ item.supplier_sku }}">
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="number" name="item_quantity_{{ item.id }}" class="form-control item-quantity"
                                                      value="{{ item.quantity_ordered }}" min="0.01" step="0.01" required>
                                                {% else %}
                                                {{ item.quantity_ordered }}
                                                <input type="hidden" name="item_quantity_{{ item.id }}" value="{{ item.quantity_ordered }}">
                                                {% endif %}
                                            </td>
                                            <td class="item-unit">{{ item.product.unit }}</td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <input type="number" name="item_price_{{ item.id }}" class="form-control item-price"
                                                      value="{{ item.unit_price }}" min="0.01" step="0.01" required>
                                                {% else %}
                                                {{ item.unit_price }}
                                                <input type="hidden" name="item_price_{{ item.id }}" value="{{ item.unit_price }}">
                                                {% endif %}
                                            </td>
                                            <td class="item-tax-rate">
                                                {% if item.tax %}
                                                    {{ item.tax.rate }}%
                                                    <input type="hidden" name="item_tax_id_{{ item.id }}" class="item-tax-id" value="{{ item.tax.id }}">
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </td>
                                            <td class="item-total">{{ item.line_total }}</td>
                                            <td>
                                                {% if form.instance.status == 'draft' %}
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    {% endif %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6" class="text-end"><strong>Zwischensumme:</strong></td>
                                        <td class="text-end"><span id="subtotal">{{ form.instance.subtotal|default:"0.00" }}</span> <span id="currencySymbol">{{ default_currency.symbol }}</span></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" class="text-end">Steuern:</td>
                                        <td class="text-end">
                                            {% if form.instance.status == 'draft' or not form.instance.pk %}
                                            <span id="taxDisplay">{{ form.instance.tax|default:"0.00" }}</span> <span id="currencySymbol2">{{ default_currency.symbol }}</span>
                                            <input type="hidden" name="tax" id="taxInput" value="{{ form.instance.tax|default:0 }}">
                                            {% else %}
                                            {{ form.instance.tax }} {{ default_currency.symbol }}
                                            <input type="hidden" name="tax" value="{{ form.instance.tax }}">
                                            {% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" class="text-end">Versandkosten:</td>
                                        <td class="text-end">
                                            {% if form.instance.status == 'draft' or not form.instance.pk %}
                                            <span id="shippingDisplay">{{ form.instance.shipping_cost|default:"0.00" }}</span> <span id="currencySymbol3">{{ default_currency.symbol }}</span>
                                            <input type="hidden" name="shipping_cost" id="shippingInput" value="{{ form.instance.shipping_cost|default:0 }}">
                                            {% else %}
                                            {{ form.instance.shipping_cost }} {{ default_currency.symbol }}
                                            <input type="hidden" name="shipping_cost" value="{{ form.instance.shipping_cost }}">
                                            {% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" class="text-end"><strong>Gesamtsumme:</strong></td>
                                        <td class="text-end"><strong><span id="total">{{ form.instance.total|default:"0.00" }}</span> <span id="currencySymbol4">{{ default_currency.symbol }}</span></strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 d-flex justify-content-between">
                <a href="{% url 'purchase_order_list' %}" class="btn btn-outline-secondary">Abbrechen</a>
                {% if not form.instance.pk or form.instance.status == 'draft' %}
                <button type="submit" class="btn btn-outline-primary">Speichern</button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Template für neue Positionen -->
<template id="newItemTemplate">
    <tr data-item-id="new_{index}">
        <td>
            <select name="item_product_new_{index}" class="form-select product-select" required
                   placeholder="Produkt suchen (SKU oder Name)">
                <option value="">-- Produkt suchen --</option>
            </select>
        </td>
        <td>
            <input type="text" name="item_supplier_sku_new_{index}" class="form-control supplier-sku" readonly>
        </td>
        <td>
            <input type="number" name="item_quantity_new_{index}" class="form-control item-quantity"
                   value="1" min="0.01" step="0.01" required>
        </td>
        <td class="item-unit">--</td>
        <td>
            <input type="number" name="item_price_new_{index}" class="form-control item-price"
                   value="0.00" min="0.01" step="0.01" required>
        </td>
        <td class="item-tax-rate">--</td>  <!-- Neue Spalte für die Steuerrate -->
        <td class="item-total">0.00</td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
// Fixed JavaScript for the Purchase Order form
$(document).ready(function() {
    // Initialize Select2 for supplier selection with search
    if($.fn.select2) {
        $('#id_supplier').select2({
            placeholder: 'Lieferant auswählen',
            width: '100%',
            allowClear: true,
            theme: 'bootstrap-5'
        });
    }

    let supplierShippingCost = 0;
    let supplierMinimumOrderValue = 0;
    let currencySymbol = '€';
    let currencyCode = 'EUR';
    let exchangeRate = 1.0;
    let itemIndex = 0;

    // Watch for supplier changes
    $('#id_supplier').on('change', function() {
        const supplierId = $(this).val();

        // Clear existing product rows
        $('#itemsTableBody').empty();

        if (supplierId) {
            // Show loading indicator
            $('#supplierLoadingIndicator').show();

            // Fetch supplier data (shipping costs, minimum order value, currency)
            $.getJSON('/suppliers/get-supplier-data/', {
                supplier_id: supplierId
            }).done(function(data) {
                if (data.success) {
                    // Store supplier data for later calculations
                    supplierShippingCost = parseFloat(data.shipping_cost);
                    supplierMinimumOrderValue = parseFloat(data.minimum_order_value);

                    // Update currency information if available
                    if (data.currency_symbol) {
                        currencySymbol = data.currency_symbol;
                        currencyCode = data.currency_code;
                        exchangeRate = parseFloat(data.exchange_rate || 1.0);

                        // Update all currency symbols in the page
                        $('[id^="currencySymbol"]').text(currencySymbol);
                    }

                    // If a minimum order value exists and is greater than 0
                    if (data.minimum_order_value > 0) {
                        // Show minimum order value notice
                        if (!$('#minimum-order-warning').length) {
                            $('<div id="minimum-order-warning" class="alert alert-warning mt-3">' +
                              '<i class="bi bi-exclamation-triangle me-2"></i>' +
                              'Mindestbestellwert für diesen Lieferanten: <strong>' + data.minimum_order_value + ' ' + currencySymbol + '</strong>' +
                              '</div>').insertAfter('#itemsTable');
                        } else {
                            $('#minimum-order-warning strong').text(data.minimum_order_value + ' ' + currencySymbol);
                        }
                    } else {
                        // Remove notice if no minimum order value
                        $('#minimum-order-warning').remove();
                    }

                    // Add a first empty row for the order
                    addNewItem();

                    // Hide loading indicator
                    $('#supplierLoadingIndicator').hide();
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error retrieving supplier data:', textStatus, errorThrown);
                $('#supplierLoadingIndicator').hide();
            });
        } else {
            // If no supplier selected, hide loading indicator
            $('#supplierLoadingIndicator').hide();
        }
    });

    // Add item button
    $('#addItemButton').click(function() {
        addNewItem();
    });

    // Remove button for existing and new rows
    $(document).on('click', '.remove-item', function() {
        $(this).closest('tr').remove();
        updateTotals();
    });

    // Function to add a new empty item
    function addNewItem() {
        // Clone and adapt template
        let template = document.getElementById('newItemTemplate').innerHTML;
        template = template.replace(/{index}/g, itemIndex++);

        // Add to table body
        $('#itemsTableBody').append(template);

        // Initialize selects
        initializeProductSelects();

        // Initialize calculations
        initializeCalculations();

        // Scroll to new element
        $('html, body').animate({
            scrollTop: $("#itemsTableBody tr:last").offset().top - 200
        }, 500);
    }

    // Product selection logic
    function initializeProductSelects() {
        // Select2 for product selection (if available)
        if($.fn.select2) {
            $('.product-select:not(.select2-hidden-accessible)').each(function() {
                $(this).select2({
                    placeholder: 'Produkt suchen (Artikelnummer oder Name)',
                    width: '100%',
                    allowClear: true,
                    ajax: {
                        url: '/order/get-supplier-products-list/',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                supplier_id: $('#id_supplier').val(),
                                q: params.term || '',
                                page: params.page || 1
                            };
                        },
                        processResults: function(data, params) {
                            params.page = params.page || 1;

                            return {
                                results: data.products.map(function(product) {
                                    return {
                                        id: product.id,
                                        text: product.sku + ' - ' + product.name,
                                        product: product
                                    };
                                }),
                                pagination: {
                                    more: data.more
                                }
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 1,
                    templateResult: formatProduct,
                    templateSelection: formatProductSelection
                }).on('select2:select', function(e) {
                    const productData = e.params.data.product;
                    if (productData) {
                        updateRowWithProductData($(this).closest('tr'), productData);
                    }
                });
            });
        }
    }

    // Format product options in dropdown
    function formatProduct(product) {
        if (product.loading) {
            return product.text;
        }

        if (!product.product) {
            return product.text;
        }

        return $(`
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div><strong>${product.product.name}</strong></div>
                    <div class="text-muted small">SKU: ${product.product.sku}</div>
                </div>
                <div class="text-end">
                    <div>${product.product.price} ${currencySymbol}</div>
                    <div class="text-muted small">Lieferant-SKU: ${product.product.supplier_sku || '-'}</div>
                </div>
            </div>
        `);
    }

    // Format selected product in dropdown
    function formatProductSelection(product) {
        if (!product.id || !product.product) {
            return product.text;
        }

        return product.product.sku + ' - ' + product.product.name;
    }

    // Update row with selected product data
    function updateRowWithProductData($row, productData) {
        // Set supplier SKU if available
        if (productData.supplier_sku) {
            $row.find('.supplier-sku').val(productData.supplier_sku);
        }

        // Set unit
        $row.find('.item-unit').text(productData.unit || '--');

        // Set price
        if (productData.price) {
            $row.find('.item-price').val(productData.price);
        }

        // Store tax information
        if (productData.tax_id !== null && productData.tax_id !== undefined) {
            const itemId = $row.data('item-id');

            // Create or update hidden field for tax_id
            let $taxIdField = $row.find('.item-tax-id');
            if ($taxIdField.length === 0) {
                $taxIdField = $('<input>')
                    .attr('type', 'hidden')
                    .addClass('item-tax-id')
                    .attr('name', 'item_tax_id_' + itemId)
                    .appendTo($row);
            }

            // Set tax rate
            $taxIdField.val(productData.tax_id);

            // Display tax rate
            const $taxRateDisplay = $row.find('.item-tax-rate');
            if ($taxRateDisplay.length > 0) {
                $taxRateDisplay.text(productData.tax_rate + '%');
            }
        }

        // Update row total
        updateRowTotal($row);

        // Focus quantity field after product selection
        setTimeout(function() {
            $row.find('.item-quantity').focus().select();
        }, 100);
    }

    // Function to retrieve and update product data from server
    function fetchAndUpdateProductData($select, productId) {
        const $row = $select.closest('tr');
        const supplierId = $('#id_supplier').val();

        if (!supplierId) {
            console.warn('No supplier selected!');
            return;
        }

        // AJAX request to get supplier data
        $.getJSON('/order/get-supplier-product-price/', {
            product_id: productId,
            supplier_id: supplierId
        }).done(function(data) {
            if (data.success) {
                // Update row with product data
                const productData = {
                    id: productId,
                    supplier_sku: data.supplier_sku,
                    price: data.price,
                    unit: data.unit,
                    tax_id: data.tax_id,
                    tax_rate: data.tax_rate
                };

                updateRowWithProductData($row, productData);
            } else {
                console.warn('No supplier data found:', data.message);
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Error retrieving supplier data:', textStatus, errorThrown);
        });
    }

    // Calculation logic
    function initializeCalculations() {
        // Quantity or price changes
        $('.item-quantity, .item-price').off('input').on('input', function() {
            updateRowTotal($(this).closest('tr'));
        });
    }

    // Calculate row total
    function updateRowTotal($row) {
        const quantity = parseFloat($row.find('.item-quantity').val()) || 0;
        const price = parseFloat($row.find('.item-price').val()) || 0;
        const total = (quantity * price).toFixed(2);

        $row.find('.item-total').text(total);

        // Update totals
        updateTotals();
    }

    // Update all totals
    function updateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        // Sum all items and calculate taxes
        $('#itemsTableBody tr').each(function() {
            // Row total without taxes
            const lineTotal = parseFloat($(this).find('.item-total').text()) || 0;
            subtotal += lineTotal;

            // Calculate tax for this row
            const taxRateText = $(this).find('.item-tax-rate').text();
            if (taxRateText && taxRateText !== '--') {
                // Extract tax rate (remove % sign)
                const taxRate = parseFloat(taxRateText.replace('%', '')) || 0;
                // Calculate tax for this row
                const lineTax = lineTotal * (taxRate / 100);
                taxTotal += lineTax;
            }
        });

        // Round to 2 decimal places
        subtotal = Math.round(subtotal * 100) / 100;
        taxTotal = Math.round(taxTotal * 100) / 100;

        // Automatically set shipping costs based on minimum order value
        let shipping = 0;
        if (supplierMinimumOrderValue > 0 && subtotal < supplierMinimumOrderValue) {
            // Set shipping costs
            shipping = supplierShippingCost;
            $('#shippingInput').val(shipping.toFixed(2));

            // Remove "free shipping" notice if present
            $('#free-shipping-info').remove();
        } else if (supplierMinimumOrderValue > 0) {
            // Order value exceeds minimum - remove shipping costs
            shipping = 0;
            $('#shippingInput').val(shipping.toFixed(2));

            // Remove notice if present
            $('#shipping-cost-warning').remove();
        }

        // Calculate total sum
        const total = subtotal + taxTotal + shipping;

        // Update sums
        $('#subtotal').text(subtotal.toFixed(2));
        $('#taxInput').val(taxTotal.toFixed(2));
        $('#taxDisplay').text(taxTotal.toFixed(2));
        $('#shippingDisplay').text(shipping.toFixed(2));
        $('#total').text(total.toFixed(2));

        // Update status display for minimum order value
        if (supplierMinimumOrderValue > 0) {
            const remainingForFreeShipping = Math.max(0, supplierMinimumOrderValue - subtotal);

            if (remainingForFreeShipping > 0) {
                // Minimum order value not yet reached
                if ($('#minimum-order-warning').length) {
                    $('#minimum-order-warning').html(
                        '<i class="bi bi-exclamation-triangle me-2"></i>' +
                        'Mindestbestellwert für diesen Lieferanten: <strong>' + supplierMinimumOrderValue.toFixed(2) + ' ' + currencySymbol + '</strong><br>' +
                        'Noch <strong>' + remainingForFreeShipping.toFixed(2) + ' ' + currencySymbol + '</strong> bis zum kostenlosen Versand'
                    );
                }
            } else {
                // Minimum order value reached
                if ($('#minimum-order-warning').length) {
                    $('#minimum-order-warning').html(
                        '<i class="bi bi-check-circle me-2"></i>' +
                        'Mindestbestellwert für kostenlosen Versand erreicht!'
                    ).removeClass('alert-warning').addClass('alert-success');
                }
            }
        }
    }

    // Handle keyboard navigation between rows
    $(document).on('keydown', '.product-select, .item-quantity, .item-price', function(e) {
        // If Enter key is pressed and not in a Select2 dropdown
        if (e.key === 'Enter' && !$(this).hasClass('select2-search__field')) {
            e.preventDefault();

            // Find the current row
            const $currentRow = $(this).closest('tr');
            const $allRows = $('#itemsTableBody tr');
            const currentIndex = $allRows.index($currentRow);

            // Get all input fields in the current row
            const $fields = $currentRow.find('input:visible, select:visible');
            const fieldIndex = $fields.index(this);

            // If this is the last field in the row
            if (fieldIndex === $fields.length - 1) {
                // If this is the last row, add a new row
                if (currentIndex === $allRows.length - 1) {
                    addNewItem();
                } else {
                    // Focus the first field in the next row
                    $allRows.eq(currentIndex + 1).find('input:visible, select:visible').first().focus();
                }
            } else {
                // Focus the next field in this row
                $fields.eq(fieldIndex + 1).focus();
            }
        }
    });

    // Handle form submission
    $('#purchase-order-form').on('submit', function(e) {
        // Validate that we have at least one product
        if ($('#itemsTableBody tr').length === 0) {
            e.preventDefault();
            alert('Bitte fügen Sie mindestens ein Produkt zur Bestellung hinzu.');
            return false;
        }

        // Check that all products have quantities and prices
        let validForm = true;
        $('#itemsTableBody tr').each(function() {
            const $productSelect = $(this).find('.product-select');
            const $quantity = $(this).find('.item-quantity');
            const $price = $(this).find('.item-price');

            // Validate product is selected
            if (!$productSelect.val()) {
                $productSelect.addClass('is-invalid');
                validForm = false;
            } else {
                $productSelect.removeClass('is-invalid');
            }

            // Validate quantity
            if (!$quantity.val() || parseFloat($quantity.val()) <= 0) {
                $quantity.addClass('is-invalid');
                validForm = false;
            } else {
                $quantity.removeClass('is-invalid');
            }

            // Validate price
            if (!$price.val() || parseFloat($price.val()) <= 0) {
                $price.addClass('is-invalid');
                validForm = false;
            } else {
                $price.removeClass('is-invalid');
            }
        });

        if (!validForm) {
            e.preventDefault();
            alert('Bitte füllen Sie alle erforderlichen Felder aus (Produkt, Menge, Preis).');
            return false;
        }

        return true;
    });

    // Check if there's a pre-selected supplier (e.g., when redirected from supplier page)
    if ($('#id_supplier').val()) {
        $('#id_supplier').trigger('change');
    }
});
</script>
{% endblock %}