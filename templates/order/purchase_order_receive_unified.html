{% extends 'base.html' %}
{% load order_filters %}

{% block title %}Wareneingang erfassen - {{ order.order_number }} - InventoryPulse{% endblock %}

{% block extra_css %}
<style>
    .batch-field, .expiry-field {
        display: none;
    }

    .has-batch .batch-field, .has-expiry .expiry-field {
        display: block;
    }

    .split-options-container {
        display: none;
    }

    .future-split-options {
        display: none;
    }

    .receipt-status-indicator {
        width: 20px;
        height: 20px;
        display: inline-block;
        border-radius: 50%;
        margin-right: 10px;
    }

    .status-full {
        background-color: #28a745;
    }

    .status-partial {
        background-color: #ffc107;
    }

    .status-none {
        background-color: #dc3545;
    }

    /* Neu: Styles für Qualitätsprobleme */
    .quality-issue-form {
        border-left: 3px solid #dc3545;
        padding: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'purchase_order_list' %}">Bestellungen</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'purchase_order_detail' order.id %}">{{ order.order_number }}</a></li>
                    <li class="breadcrumb-item active">Wareneingang erfassen</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">Wareneingang für Bestellung {{ order.order_number }} erfassen</h1>
            <p class="text-muted">Lieferant: {{ order.supplier.name }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'purchase_order_detail' order.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Zurück zur Bestellung
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Haupt-Wareneingangsformular -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Artikel</h5>
                    <div class="form-check" id="partialDeliveryDetector">
                        <input type="checkbox" class="form-check-input" id="detectPartialDelivery" checked>
                        <label class="form-check-label" for="detectPartialDelivery">Teillieferung automatisch erkennen</label>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="receiveForm">
                        {% csrf_token %}

                        <!-- Existierende Teillieferungen (falls vorhanden) -->
                        <div id="existingSplitsContainer" style="display: none;">
                            <div class="alert alert-info mb-4">
                                <h5 class="alert-heading"><i class="bi bi-info-circle me-2"></i> Geplante Teillieferungen vorhanden</h5>
                                <p>Für diese Bestellung wurden bereits Teillieferungen angelegt:</p>
                                <div id="existingSplitsList" class="list-group mb-3"></div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="useExistingSplit" name="use_existing_split">
                                    <label class="form-check-label" for="useExistingSplit">Eine bestehende Teillieferung für diesen Wareneingang verwenden</label>
                                </div>
                                <div class="mt-2" id="selectExistingSplitContainer" style="display: none;">
                                    <select id="existingSplitSelect" name="existing_split_id" class="form-select">
                                        <option value="">-- Teillieferung auswählen --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Teillieferungsoptionen -->
                        <div id="splitOptionsContainer" class="split-options-container mt-4 p-3 border rounded bg-light" style="display: none;">
                            <h5><i class="bi bi-boxes me-2"></i>Teillieferungsinformationen</h5>
                            <p class="text-info">
                                <i class="bi bi-info-circle me-1"></i>
                                Eine oder mehrere Positionen wurden nur teilweise geliefert. Möchten Sie dies als Teillieferung erfassen?
                            </p>

                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="createSplit" name="create_split" value="yes" checked>
                                <label class="form-check-label" for="createSplit">Diese als Teillieferung erfassen</label>
                            </div>

                            <div id="splitDetailsContainer">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="splitName" class="form-label">Bezeichnung der Teillieferung</label>
                                        <input type="text" class="form-control" id="splitName" name="split_name"
                                                placeholder="z.B. Erste Lieferung">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="trackingNumber" class="form-label">Tracking-Nummer</label>
                                        <input type="text" class="form-control" id="trackingNumber" name="tracking_number" placeholder="Optional">
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="createFutureSplit" name="create_future_split" value="yes">
                                    <label class="form-check-label" for="createFutureSplit">Restlieferung automatisch planen</label>
                                </div>

                                <div id="futureSplitOptions" class="future-split-options mb-3 p-3 border rounded" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="futureSplitName" class="form-label">Bezeichnung der Restlieferung</label>
                                            <input type="text" class="form-control" id="futureSplitName" name="future_split_name"
                                                    placeholder="z.B. Restlieferung">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="futureDeliveryDate" class="form-label">Erwartetes Lieferdatum</label>
                                            <input type="date" class="form-control" id="futureDeliveryDate" name="future_delivery_date">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Artikeltabelle -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Artikel</th>
                                        <th style="width: 15%;">Bestellt</th>
                                        <th style="width: 15%;">Bereits erhalten</th>
                                        <th style="width: 15%;">Jetzt erhalten</th>
                                        <th style="width: 15%;">Ziel-Lager</th>
                                        {% if has_batch_products %}
                                        <th style="width: 15%;">Chargennummer</th>
                                        {% endif %}
                                        {% if has_expiry_products %}
                                        <th style="width: 15%;">Verfallsdatum</th>
                                        {% endif %}
                                        <th style="width: 5%;">Qualität</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr class="{% if item.product.has_batch_tracking %}has-batch{% endif %} {% if item.product.has_expiry_tracking %}has-expiry{% endif %}" data-item-id="{{ item.id }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <a href="{% url 'product_detail' item.product.id %}" target="_blank">{{ item.product.name }}</a>
                                                <span class="badge bg-secondary ms-2">{{ item.product.sku }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {{ item.quantity_ordered }} {{ item.product.unit }}
                                            <input type="hidden" id="ordered_{{ item.id }}" value="{{ item.quantity_ordered }}">
                                        </td>
                                        <td>
                                            {{ item.quantity_received }} {{ item.product.unit }}
                                            <input type="hidden" id="received_{{ item.id }}" value="{{ item.quantity_received }}">
                                            <div class="progress mt-1" style="height: 5px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ item.quantity_received|div:item.quantity_ordered|mul:100 }}%;"
                                                     aria-valuenow="{{ item.quantity_received|div:item.quantity_ordered|mul:100 }}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100"></div>
                                            </div>
                                            <input type="hidden" id="remaining_{{ item.id }}" value="{{ item.quantity_ordered|sub:item.quantity_received }}">
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                <input type="number" name="receive_quantity_{{ item.id }}"
                                                       id="receive_quantity_{{ item.id }}"
                                                       class="form-control receive-quantity"
                                                       value="{{ item.quantity_ordered|sub:item.quantity_received }}"
                                                       min="0" max="{{ item.quantity_ordered|sub:item.quantity_received }}"
                                                       step="0.01" required>
                                                <span class="input-group-text">{{ item.product.unit }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <select name="warehouse_{{ item.id }}" class="form-select" required>
                                                <option value="">-- Lager wählen --</option>
                                                {% for warehouse in warehouses %}
                                                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        {% if has_batch_products %}
                                        <td class="batch-field">
                                            <input type="text" name="batch_{{ item.id }}"
                                                   class="form-control"
                                                   placeholder="Chargennummer"
                                                   {% if item.product.has_batch_tracking %}required{% endif %}>
                                        </td>
                                        {% endif %}
                                        {% if has_expiry_products %}
                                        <td class="expiry-field">
                                            <input type="date" name="expiry_{{ item.id }}"
                                                   class="form-control"
                                                   {% if item.product.has_expiry_tracking %}required{% endif %}>
                                        </td>
                                        {% endif %}
                                        <td>
                                            <!-- Qualitätsmangelschalter -->
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input quality-issue-toggle"
                                                       id="quality_issue_{{ item.id }}"
                                                       name="has_quality_issue_{{ item.id }}"
                                                       data-item-id="{{ item.id }}">
                                                <label class="form-check-label" for="quality_issue_{{ item.id }}">
                                                    <i class="bi bi-exclamation-triangle text-warning"></i>
                                                </label>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Qualitätsmängelformular für diesen Artikel -->
                                    <tr class="quality-issue-row" id="quality_issue_form_{{ item.id }}" style="display: none;">
                                        <td colspan="{% if has_batch_products and has_expiry_products %}8{% elif has_batch_products or has_expiry_products %}7{% else %}6{% endif %}">
                                            <div class="quality-issue-form p-3">
                                                <h6><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Qualitätsmangel melden</h6>
                                                <div class="row mb-2">
                                                    <div class="col-md-3">
                                                        <label class="form-label small">Mangelhafte Menge</label>
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" class="form-control defective-quantity"
                                                                   name="defective_quantity_{{ item.id }}"
                                                                   min="0.01" step="0.01" max="{{ item.quantity_ordered|sub:item.quantity_received }}"
                                                                   placeholder="Menge">
                                                            <span class="input-group-text">{{ item.product.unit }}</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label small">Problemtyp</label>
                                                        <select class="form-select form-select-sm" name="issue_type_{{ item.id }}">
                                                            <option value="defective">Defekt</option>
                                                            <option value="damaged">Beschädigt</option>
                                                            <option value="wrong_item">Falscher Artikel</option>
                                                            <option value="wrong_quantity">Falsche Menge</option>
                                                            <option value="expired">Abgelaufen</option>
                                                            <option value="other">Sonstiges</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label small">Beschreibung</label>
                                                        <textarea class="form-control form-control-sm" name="issue_description_{{ item.id }}"
                                                                  rows="2" placeholder="Beschreibung des Problems"></textarea>
                                                    </div>
                                                </div>
                                                <div class="form-check form-check-inline mt-2">
                                                    <input class="form-check-input" type="checkbox" name="create_rma_{{ item.id }}"
                                                           id="create_rma_{{ item.id }}" checked>
                                                    <label class="form-check-label small" for="create_rma_{{ item.id }}">
                                                        RMA für diesen Artikel erstellen
                                                    </label>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="{% if has_batch_products and has_expiry_products %}8{% elif has_batch_products or has_expiry_products %}7{% else %}6{% endif %}" class="text-center">
                                            Keine Artikel zur Erfassung verfügbar.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Teillieferungsoptionen -->
                        <div id="splitOptionsContainer" class="split-options-container mt-4 p-3 border rounded bg-light">
                            <h5><i class="bi bi-boxes me-2"></i>Teillieferungsinformationen</h5>
                            <p class="text-info">
                                <i class="bi bi-info-circle me-1"></i>
                                Eine oder mehrere Positionen wurden nur teilweise geliefert. Möchten Sie dies als Teillieferung erfassen?
                            </p>

                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="createSplit" name="create_split" value="yes" checked>
                                <label class="form-check-label" for="createSplit">Diese als Teillieferung erfassen</label>
                            </div>

                            <div id="splitDetailsContainer">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="splitName" class="form-label">Bezeichnung der Teillieferung</label>
                                        <input type="text" class="form-control" id="splitName" name="split_name"
                                               placeholder="z.B. Erste Lieferung">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="trackingNumber" class="form-label">Tracking-Nummer</label>
                                        <input type="text" class="form-control" id="trackingNumber" name="tracking_number" placeholder="Optional">
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="createFutureSplit" name="create_future_split" value="yes">
                                    <label class="form-check-label" for="createFutureSplit">Restlieferung automatisch planen</label>
                                </div>

                                <div id="futureSplitOptions" class="future-split-options mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="futureSplitName" class="form-label">Bezeichnung der Restlieferung</label>
                                            <input type="text" class="form-control" id="futureSplitName" name="future_split_name"
                                                   placeholder="z.B. Restlieferung">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="futureDeliveryDate" class="form-label">Erwartetes Lieferdatum</label>
                                            <input type="date" class="form-control" id="futureDeliveryDate" name="future_delivery_date">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Anmerkungen -->
                        <div class="mb-3 mt-4">
                            <label for="notes" class="form-label">Anmerkungen zum Wareneingang</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Optionale Anmerkungen zum Wareneingang..."></textarea>
                        </div>

                        <!-- Aktionen -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'purchase_order_detail' order.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Abbrechen
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-box-seam"></i> Wareneingang speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal für die RMA-Zusammenfassung nach dem Speichern -->
<div class="modal fade" id="rmaConfirmationModal" tabindex="-1" aria-labelledby="rmaConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rmaConfirmationModalLabel">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            RMA für mangelhafte Artikel erstellen
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Die folgenden Artikel wurden mit Qualitätsmängeln erfasst. Möchten Sie jetzt eine RMA erstellen?</p>
        <div id="defectiveItemsSummary"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <a href="#" id="createRmaLink" class="btn btn-primary">
            <i class="bi bi-file-earmark-text me-2"></i> RMA erstellen
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Get the order ID from the URL or a data attribute
    const orderId = {{ order.id }};

    // Qualitätsmängel-Checkboxen Funktionalität
    $('.quality-issue-toggle').change(function() {
        const itemId = $(this).data('item-id');
        const isChecked = $(this).prop('checked');

        // Formularzeile anzeigen/ausblenden
        $(`#quality_issue_form_${itemId}`).toggle(isChecked);

        // Alternativ, falls das nicht funktioniert:
        if (isChecked) {
            $(`#quality_issue_form_${itemId}`).show();
            $(`#quality_issue_form_${itemId} .quality-issue-form`).show();
        } else {
            $(`#quality_issue_form_${itemId}`).hide();
        }

        // Wenn aktiviert, Eingabe der mangelhaften Menge fokussieren
        if(isChecked) {
            $(`input[name="defective_quantity_${itemId}"]`).focus();
        }
    });

    // Sicherstellen, dass die defekte Menge nicht größer als die empfangene Menge ist
    $('.defective-quantity').on('input', function() {
        const itemId = $(this).attr('name').replace('defective_quantity_', '');
        const receivedQuantity = parseFloat($(`#receive_quantity_${itemId}`).val()) || 0;
        const defectiveQuantity = parseFloat($(this).val()) || 0;

        if(defectiveQuantity > receivedQuantity) {
            $(this).val(receivedQuantity);
        }
    });

    // Wenn die empfangene Menge geändert wird, die maximale defekte Menge anpassen
    $('.receive-quantity').on('input', function() {
        const itemId = $(this).attr('id').replace('receive_quantity_', '');
        const receivedQuantity = parseFloat($(this).val()) || 0;
        const defectiveInput = $(`input[name="defective_quantity_${itemId}"]`);
        const defectiveQuantity = parseFloat(defectiveInput.val()) || 0;

        defectiveInput.attr('max', receivedQuantity);

        if(defectiveQuantity > receivedQuantity) {
            defectiveInput.val(receivedQuantity);
        }
    });

    // Funktion zur Überprüfung und Anpassung der Form-Validierung basierend auf der Eingabemenge
    function updateFieldRequirements() {
        $('.receive-quantity').each(function() {
            const $this = $(this);
            const $row = $this.closest('tr');
            const quantity = parseFloat($this.val()) || 0;

            // ID des aktuellen Elements ermitteln
            const itemId = $row.data('item-id');

            // Selektoren für zugehörige Felder
            const $warehouseSelect = $row.find(`select[name="warehouse_${itemId}"]`);
            const $batchInput = $row.find(`input[name="batch_${itemId}"]`);
            const $expiryInput = $row.find(`input[name="expiry_${itemId}"]`);

            if (quantity > 0) {
                // Wenn eine positive Menge eingegeben wurde, Felder als required markieren
                $warehouseSelect.prop('required', true);

                // Batch-Feld nur als required markieren, wenn Produkt Batch-Tracking hat
                if ($row.hasClass('has-batch')) {
                    $batchInput.prop('required', true);
                }

                // Verfallsdatum-Feld nur als required markieren, wenn Produkt Verfallsdatum-Tracking hat
                if ($row.hasClass('has-expiry')) {
                    $expiryInput.prop('required', true);
                }
            } else {
                // Wenn Menge 0 oder leer ist, Felder als nicht required markieren
                $warehouseSelect.prop('required', false);
                $batchInput.prop('required', false);
                $expiryInput.prop('required', false);
            }
        });
    }

    // Prüfen, ob die Bestellung bereits Teillieferungen hat
    $.ajax({
        url: '/order/' + orderId + '/splits/check/',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            if (data.has_splits) {
                // Existierende Teillieferungen anzeigen
                $('#existingSplitsContainer').show();

                // Teillieferungen auflisten
                const $splitsList = $('#existingSplitsList');
                const $splitsSelect = $('#existingSplitSelect');
                $splitsList.empty();
                $splitsSelect.find('option:not(:first-child)').remove();

                data.splits.forEach(function(split) {
                    // Liste für Anzeige
                    const statusClass = split.status === 'Geplant' ? 'list-group-item-secondary' :
                                       (split.status === 'In Transit' ? 'list-group-item-info' : 'list-group-item-success');

                    $splitsList.append(
                        `<div class="list-group-item ${statusClass} d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${split.name}</strong>
                                <span class="badge bg-secondary ms-2">${split.status}</span>
                            </div>
                            <div>
                                <span class="badge text-bg-primary">${split.items_count} Positionen</span>
                            </div>
                        </div>`
                    );

                    // Dropdown für Auswahl
                    if (split.status !== 'Erhalten') {
                        $splitsSelect.append(
                            `<option value="${split.id}">${split.name} (${split.status})</option>`
                        );
                    }
                });
            }
        }
    });

    // Option zum Verwenden einer existierenden Teillieferung umschalten
    $('#useExistingSplit').change(function() {
        const useExistingSplit = $(this).is(':checked');
        $('#selectExistingSplitContainer').toggle(useExistingSplit);

        // Wenn existierende Teillieferung ausgewählt wird, die Option für neue Teillieferung deaktivieren
        if (useExistingSplit) {
            $('#createSplit').prop('checked', false);
            $('#splitDetailsContainer').hide();
            // Auch das Container-Element ausblenden
            $('#splitOptionsContainer').hide();
        } else {
            // Wenn die Teillieferungserkennung es erfordert, die Option für neue Teillieferung wieder einblenden
            if (isPartialDelivery && $('#detectPartialDelivery').is(':checked')) {
                $('#splitOptionsContainer').show();
            }
        }
    });

    // Alle Mengen-Eingabefelder überwachen, um Teillieferungsstatus zu erkennen
    let isPartialDelivery = false;

    function checkForPartialDelivery() {
        isPartialDelivery = false;

        $('.receive-quantity').each(function() {
            const $row = $(this).closest('tr');
            const itemId = $row.data('item-id');
            const receivedQuantity = parseFloat($('#received_' + itemId).val()) || 0;
            const enteredQuantity = parseFloat($(this).val()) || 0;
            const orderedQuantity = parseFloat($('#ordered_' + itemId).val()) || 0;

            // Wenn die eingegebene + bereits erhaltene Menge kleiner als die bestellte Menge ist
            if (receivedQuantity + enteredQuantity < orderedQuantity && enteredQuantity > 0) {
                isPartialDelivery = true;
                return false; // exit the loop early if we found a partial delivery
            }
    });

    // Teillieferungsoptionen anzeigen/ausblenden
    if (isPartialDelivery && $('#detectPartialDelivery').is(':checked') && !$('#useExistingSplit').is(':checked')) {
        $('#splitOptionsContainer').slideDown();
    } else {
        $('#splitOptionsContainer').slideUp();
    }
}

// Events registrieren
$('.receive-quantity').on('input', function() {
    checkForPartialDelivery();
    updateFieldRequirements(); // Zusätzlich die Feld-Requirements aktualisieren
});

$('#detectPartialDelivery').change(function() {
    checkForPartialDelivery();
});

// Teillieferungsoptionen umschalten
$('#createSplit').change(function() {
    const createSplit = $(this).is(':checked');
    $('#splitDetailsContainer').toggle(createSplit);

    // Wenn neue Teillieferung ausgewählt wird, die Option für existierende Teillieferung deaktivieren
    if (createSplit) {
        $('#useExistingSplit').prop('checked', false);
        $('#selectExistingSplitContainer').hide();
    }
});

// Restlieferungsoptionen umschalten
$('#createFutureSplit').change(function() {
    $('#futureSplitOptions').toggle(this.checked);
});

// Initial check for partial delivery and field requirements
checkForPartialDelivery();
updateFieldRequirements();

// Standardwerte für Teillieferungsbezeichnungen setzen
const today = new Date();
const formattedDate = today.toLocaleDateString('de-DE');
$('#splitName').val(`Wareneingang vom ${formattedDate}`);
$('#futureSplitName').val('Restlieferung');

// Zukünftiges Lieferdatum standardmäßig auf 2 Wochen setzen
const futureDate = new Date();
futureDate.setDate(today.getDate() + 14);
$('#futureDeliveryDate').val(futureDate.toISOString().slice(0, 10));

// Form-Validierung
$('#receiveForm').submit(function(e) {
    // Prüfen, ob mindestens eine Position einen Wert größer als 0 hat
    let hasReceivedItems = false;

    $('.receive-quantity').each(function() {
        if (parseFloat($(this).val()) > 0) {
            hasReceivedItems = true;
            return false; // break loop
        }
    });

    if (!hasReceivedItems) {
        e.preventDefault();
        alert('Bitte geben Sie mindestens eine Wareneingangsposition ein.');
        return false;
    }

    // Prüfen, ob sowohl neue als auch existierende Teillieferung ausgewählt wurden (sollte nicht möglich sein)
    if ($('#useExistingSplit').is(':checked') && $('#createSplit').is(':checked')) {
        e.preventDefault();
        alert('Sie können nicht gleichzeitig eine bestehende Teillieferung verwenden und eine neue erstellen. Bitte wählen Sie eine Option.');
        return false;
    }

    // Wenn bestehende Teillieferung ausgewählt ist, aber keine ausgewählt wurde
    if ($('#useExistingSplit').is(':checked') && (!$('#existingSplitSelect').val() || $('#existingSplitSelect').val() === '')) {
        e.preventDefault();
        alert('Bitte wählen Sie eine existierende Teillieferung aus dem Dropdown-Menü.');
        $('#existingSplitSelect').focus();
        return false;
    }

    // Wenn "Teillieferung erfassen" aktiviert ist, aber kein Name angegeben wurde
    if (isPartialDelivery && $('#createSplit').is(':checked') && $('#splitName').val().trim() === '') {
        e.preventDefault();
        alert('Bitte geben Sie einen Namen für die Teillieferung ein.');
        $('#splitName').focus();
        return false;
    }

    // Wenn "Restlieferung planen" aktiviert ist, aber kein Name angegeben wurde
    if ($('#createFutureSplit').is(':checked') && $('#futureSplitName').val().trim() === '') {
        e.preventDefault();
        alert('Bitte geben Sie einen Namen für die geplante Restlieferung ein.');
        $('#futureSplitName').focus();
        return false;
    }

    // Validierung für Qualitätsmängel
    let hasQualityIssues = false;
    $('.quality-issue-toggle:checked').each(function() {
        const itemId = $(this).data('item-id');
        const defectiveQuantity = parseFloat($(`input[name="defective_quantity_${itemId}"]`).val()) || 0;
        const issueDescription = $(`textarea[name="issue_description_${itemId}"]`).val().trim();

        // Prüfen ob Qualitätsmängel vollständig ausgefüllt sind
        if (defectiveQuantity <= 0) {
            e.preventDefault();
            alert('Bitte geben Sie die mangelhafte Menge für alle markierten Artikel an.');
            $(`input[name="defective_quantity_${itemId}"]`).focus();
            return false;
        }

        if (!issueDescription) {
            e.preventDefault();
            alert('Bitte beschreiben Sie den Qualitätsmangel für alle markierten Artikel.');
            $(`textarea[name="issue_description_${itemId}"]`).focus();
            return false;
        }

        hasQualityIssues = true;
    });

    // Sammeln von Informationen über defekte Artikel für die Session
    if (hasQualityIssues) {
        const defectiveItems = [];

        $('.quality-issue-toggle:checked').each(function() {
            const itemId = $(this).data('item-id');
            const defectiveQuantity = parseFloat($(`input[name="defective_quantity_${itemId}"]`).val()) || 0;
            const issueType = $(`select[name="issue_type_${itemId}"]`).val();
            const issueDescription = $(`textarea[name="issue_description_${itemId}"]`).val().trim();
            const createRma = $(`input[name="create_rma_${itemId}"]`).is(':checked');

            defectiveItems.push({
                receipt_item_id: itemId,
                quantity: defectiveQuantity,
                issue_type: issueType,
                issue_description: issueDescription,
                create_rma: createRma
            });
        });

        // Füge die defekten Artikel als Hidden Input zum Formular hinzu
        $('<input>').attr({
            type: 'hidden',
            name: 'defective_items',
            value: JSON.stringify(defectiveItems)
        }).appendTo('#receiveForm');
    }

    // Zusätzliche Validierung für Felder mit Menge > 0
    let formValid = true;
    $('.receive-quantity').each(function() {
        const $this = $(this);
        const $row = $this.closest('tr');
        const quantity = parseFloat($this.val()) || 0;
        const itemId = $row.data('item-id');

        if (quantity > 0) {
            // Lager muss ausgewählt sein
            const $warehouse = $row.find(`select[name="warehouse_${itemId}"]`);
            if (!$warehouse.val()) {
                formValid = false;
                alert('Bitte wählen Sie ein Ziellager für alle Positionen mit Wareneingangsmenge > 0.');
                $warehouse.focus();
                return false;  // break loop
            }

            // Batch-Nummer prüfen, falls erforderlich
            if ($row.hasClass('has-batch')) {
                const $batch = $row.find(`input[name="batch_${itemId}"]`);
                if (!$batch.val().trim()) {
                    formValid = false;
                    alert('Bitte geben Sie eine Chargennummer für alle Produkte mit Chargen-Tracking ein.');
                    $batch.focus();
                    return false;  // break loop
                }
            }

            // Verfallsdatum prüfen, falls erforderlich
            if ($row.hasClass('has-expiry')) {
                const $expiry = $row.find(`input[name="expiry_${itemId}"]`);
                if (!$expiry.val()) {
                    formValid = false;
                    alert('Bitte geben Sie ein Verfallsdatum für alle Produkte mit Verfallsdatum-Tracking ein.');
                    $expiry.focus();
                    return false;  // break loop
                }
            }
        }
    });

    if (!formValid) {
        e.preventDefault();
        return false;
    }

    return true;
});

// Batch- und Verfallsdatenfelder initialisieren
$('.batch-field, .expiry-field').each(function() {
    // Nur Felder anzeigen, die für das jeweilige Produkt benötigt werden
    const $row = $(this).closest('tr');
    if ($row.hasClass('has-batch')) {
        $row.find('.batch-field').show();
    }
    if ($row.hasClass('has-expiry')) {
        $row.find('.expiry-field').show();
    }
});

// Hilfsfunktion zum Formatieren von Datumswerten
function formatDate(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${year}-${month}-${day}`;
}
});
</script>
{% endblock %}
